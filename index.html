<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Preflop Advisor — ממשק</title>
  <style>
    :root { --bd:#e5e7eb; --tx:#111827; --sub:#6b7280; --ok:#065f46; --err:#991b1b; --chip:#111827; }
    *{box-sizing:border-box}
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:#fafafa; color:var(--tx); }
    header { padding:14px 16px; background:#fff; border-bottom:1px solid var(--bd); position:sticky; top:0; }
    h1 { margin:0; font-size:20px; }
    main { max-width:980px; margin:20px auto; padding:0 16px; }
    .tabs { display:flex; gap:10px; margin-bottom:14px; }
    .tab { padding:10px 14px; border:1px solid var(--bd); border-bottom:none; border-radius:10px 10px 0 0; background:#f3f4f6; cursor:pointer; }
    .tab.active { background:#fff; font-weight:600; }
    .pane { display:none; } .pane.active { display:block; }
    .card { background:#fff; border:1px solid var(--bd); border-radius:16px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { font-size:13px; color:var(--sub); display:block; margin:0 0 6px; }
    input, select, button { font-size:15px; padding:10px 12px; border-radius:10px; border:1px solid var(--bd); background:#fff; }
    input[type="number"] { width:120px; }
    .w120 { width:120px; } .w160 { width:160px; }
    button { cursor:pointer; }
    button.primary { background:var(--chip); color:#fff; border-color:var(--chip); }
    .result { border:1px dashed var(--bd); border-radius:12px; padding:12px; background:#fcfcfc; min-height:44px; }
    .msg { padding:10px 12px; border-radius:10px; }
    .msg.ok { background:#ecfdf5; color:var(--ok); border:1px solid #a7f3d0; }
    .msg.err { background:#fef2f2; color:var(--err); border:1px solid #fecaca; }
    .kvs { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .kv { padding:6px 10px; border-radius:999px; background:#f3f4f6; font-size:13px; }
    .muted { color:var(--sub); font-size:13px; margin-top:6px; }
    .spinner { display:none; width:16px; height:16px; border:2px solid #d1d5db; border-top-color:#111827; border-radius:50%; animation:spin .8s linear infinite; vertical-align:middle; margin-inline-start:8px;}
    .spinner.show { display:inline-block; }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<header><h1>ממשק — Preflop Advisor</h1></header>
<main>

  <!-- טאבים -->
  <div class="tabs">
    <div class="tab active" data-tab="open">קופה לא פתוחה (Open/Shove)</div>
    <div class="tab" data-tab="vsopen">מול פתיחה (3-Bet)</div>
  </div>

  <!-- טאב: Open/Shove -->
  <section class="pane active" id="pane-open">
    <div class="card">
      <div class="row" style="margin-bottom:10px;"><div style="font-weight:600">המלצת פתיחה (Open/Shove)</div></div>
      <div class="row">
        <div><label>יד</label><input id="hand1" class="w160" placeholder="AKs / AJo / 22 / AhKh"></div>
        <div><label>עמדה</label><select id="pos1" class="w120">
          <option>UTG</option><option>MP</option><option>HJ</option><option>CO</option><option>BTN</option><option>SB</option><option>BB</option>
        </select></div>
        <div><label>(BB) סטאק</label><input id="stack1" type="number" value="40" min="1" step="1"></div>
        <div><label>מצב</label><select id="ctx1" class="w120">
          <option value="auto" selected>auto</option><option value="open">open</option><option value="shove">shove</option>
        </select></div>
        <div><button id="btn1" class="primary">חשב</button><span class="spinner" id="sp1"></span></div>
      </div>
      <div style="margin-top:12px;"><div class="result" id="out1">—</div></div>
      <div class="muted">טיפ: שמור קיצור דרך למסך הזה בנייד.</div>
    </div>
  </section>

  <!-- טאב: Vs Open (3-bet) -->
  <section class="pane" id="pane-vsopen">
    <div class="card">
      <div class="row" style="margin-bottom:10px;"><div style="font-weight:600">מול פתיחה (3-Bet)</div></div>
      <div class="row">
        <div><label>יד</label><input id="hand2" class="w160" placeholder="QQ / A5s / AQo"></div>
        <div><label>העמדה שלך</label><select id="hero2" class="w120">
          <option>UTG</option><option>MP</option><option>HJ</option><option>CO</option><option>BTN</option><option>SB</option><option>BB</option>
        </select></div>
        <div><label>עמדת הפותח</label><select id="opener2" class="w120">
          <option>UTG</option><option>MP</option><option>HJ</option><option>CO</option><option>BTN</option>
        </select></div>
        <div><label>(BB) סטאק</label><input id="stack2" type="number" value="50" min="1" step="1"></div>
        <div><button id="btn2" class="primary">חשב</button><span class="spinner" id="sp2"></span></div>
      </div>
      <div style="margin-top:12px;"><div class="result" id="out2">—</div></div>
      <div class="muted">נשלח ל-API: ‎/vs-open</div>
    </div>
  </section>

  <!-- מחשבון יחס קופה: מופיע תמיד -->
  <section class="card">
    <div class="row" style="margin-bottom:10px;"><div style="font-weight:600">מחשבון יחס קופה (Pot Odds)</div></div>
    <div class="row">
      <div><label>גודל קופה לפני קול (כולל הימור היריב)</label><input id="pot" type="number" step="0.01" value="100"></div>
      <div><label>סכום לקול (To Call)</label><input id="call" type="number" step="0.01" value="25"></div>
      <div><label>רייק במטבע (אופציונלי)</label><input id="rake" type="number" step="0.01" value="0"></div>
      <div><label>אקוויטי שלך % (אופציונלי)</label><input id="eq" type="number" step="0.1" placeholder="למשל 35"></div>

      <!-- עוזר אאוטים -->
      <div>
        <label>או חשב לפי אאוטים</label>
        <div class="row" style="gap:6px; align-items:center;">
          <select id="street" class="w120" title="מצב היד">
            <option value="flop" selected>Flop → River (×4)</option>
            <option value="turn">Turn → River (×2)</option>
          </select>
          <input id="outs" type="number" step="1" min="0" placeholder="מס’ אאוטים">
          <button id="btnOuts" type="button">חשב אקוויטי</button>
        </div>
        <div id="outsNote" class="muted"></div>
      </div>

      <div><button id="btnPot" class="primary">חשב</button></div>
    </div>
    <div style="margin-top:12px;"><div class="result" id="outPot">—</div></div>
    <div class="muted">נוסחה: Required = ToCall / (Pot + ToCall). אם הוזן Equity — תקבל גם EV וגם המלצה (Call/Fold).</div>
  </section>

</main>

<script>
  /* ===== קונפיג ===== */
  const API_BASE_URL = "https://preflop-zon3.onrender.com";

  /* ===== Tabs ===== */
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.pane').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('pane-' + t.dataset.tab).classList.add('active');
    });
  });

  /* ===== Helpers ===== */
  const byId = (id) => document.getElementById(id);
  const show = (el, on) => el.classList.toggle('show', !!on);

  function renderOpenResult(container, obj) {
    if (!obj) { container.textContent = '—'; return; }
    if (obj.error) {
      container.innerHTML = '<div class="msg err"><b>שגיאה:</b> ' + obj.error + '</div>';
      return;
    }
    let html = '';
    if (obj.decision) html += '<div class="msg ok"><b>' + obj.decision + '</b></div>';
    let kvs = [];
    if (obj.sizing) kvs.push('סייזינג: ' + obj.sizing);
    if (obj.why)    kvs.push('הסבר: ' + obj.why);
    if (kvs.length) html += '<div class="kvs">' + kvs.map(k => '<span class="kv">'+k+'</span>').join('') + '</div>';
    container.innerHTML = html || '<pre>'+JSON.stringify(obj,null,2)+'</pre>';
  }

  function renderVsOpen(container, obj){
    if (!obj) { container.textContent = '—'; return; }
    if (obj.error) { container.innerHTML = '<div class="msg err"><b>שגיאה:</b> '+obj.error+'</div>'; return; }
    let html = '';
    if (obj.decision) html += '<div class="msg ok"><b>'+obj.decision+'</b></div>';
    let kvs = [];
    if (obj.sizing) kvs.push('סייזינג: ' + obj.sizing);
    if (obj.why)    kvs.push('הסבר: '   + obj.why);
    if (kvs.length) html += '<div class="kvs">' + kvs.map(k => '<span class="kv">'+k+'</span>').join('') + '</div>';
    container.innerHTML = html || '<pre>'+JSON.stringify(obj,null,2)+'</pre>';
  }

  async function callJSON(url, body) {
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      let t = await res.text();
      try { return JSON.parse(t); } catch(e) { throw new Error('HTTP '+res.status+' '+t); }
    }
    return res.json();
  }

  /* ===== Open/Shove ===== */
  byId('btn1').addEventListener('click', async () => {
    const out = byId('out1'), sp = byId('sp1');
    try {
      const hand = byId('hand1').value.trim();
      const position = byId('pos1').value.trim();
      const stack = Number(byId('stack1').value);
      const context = byId('ctx1').value;
      if (!hand || !position || !stack) {
        renderOpenResult(out, {error:'נא למלא יד, עמדה וסטאק'}); return;
      }
      show(sp, true); out.textContent = 'טוען...';
      const data = await callJSON(`${API_BASE_URL}/recommend`, {hand, position, stack, context});
      renderOpenResult(out, data);
    } catch (err) {
      renderOpenResult(out, {error: String(err.message || err)});
    } finally {
      show(sp, false);
    }
  });

  /* ===== Pot Odds (כולל הימור היריב) ===== */
  function requiredEquity_after(toCall, potBefore) {
    return toCall / (potBefore + toCall);
  }
  function callEV_withRake(equity, potBefore, toCall, rake = 0) {
    const finalPot = potBefore + toCall; // לפני רייק
    return equity * (finalPot - rake) - (1 - equity) * toCall;
  }

  // עוזר אאוטים
  function equityFromOuts(outs, street) {
    const mult = (street === 'turn') ? 2 : 4; // flop->river=×4, turn->river=×2
    return Math.min(100, Math.max(0, outs * mult)); // באחוזים
  }
  function updateOutsNote() {
    const street = byId('street').value;
    const outs   = Number(byId('outs').value || 0);
    const eqPct  = equityFromOuts(outs, street);
    const note   = (street === 'turn')
      ? `Turn → River: כלל ×2. ${outs} אאוטים ≈ ${eqPct.toFixed(1)}% אקוויטי.`
      : `Flop → River: כלל ×4. ${outs} אאוטים ≈ ${eqPct.toFixed(1)}% אקוויטי.`;
    byId('outsNote').textContent = (outs > 0) ? note : '';
  }
  byId('btnOuts').addEventListener('click', () => {
    const street = byId('street').value;
    const outs   = Number(byId('outs').value || 0);
    const eqPct  = equityFromOuts(outs, street);
    byId('eq').value = eqPct.toFixed(1);
    updateOutsNote();
  });
  byId('street').addEventListener('change', updateOutsNote);
  byId('outs').addEventListener('input', updateOutsNote);

  // חישוב Pot Odds + המלצה
  byId('btnPot').addEventListener('click', () => {
    const pot    = Number(byId('pot').value);
    const toCall = Number(byId('call').value);
    const rake   = Number(byId('rake').value || 0);
    const eqRaw  = byId('eq').value;
    const out    = byId('outPot');

    if (!(pot >= 0) || !(toCall > 0)) {
      out.innerHTML = '<div class="msg err"><b>שגיאה:</b> נא להזין קופה ≥ 0 וסכום לקול > 0</div>';
      return;
    }

    const req = requiredEquity_after(toCall, pot); // 0..1
    const finalPot = pot + toCall;
    let html = '';
    html += `<div class="msg ok"><b>Required Equity:</b> ${(req*100).toFixed(2)}%</div>`;
    html += '<div class="kvs">';
    html += `<span class="kv">Final Pot: ${finalPot.toFixed(2)}</span>`;
    html += `<span class="kv">Rake בחישוב: ${rake.toFixed(2)}</span>`;
    html += '</div>';

    if (eqRaw !== '') {
      const eq = Math.max(0, Math.min(100, Number(eqRaw))) / 100;
      const ev = callEV_withRake(eq, pot, toCall, rake);
      const recommendation = (eq + 1e-9 >= req) ? 'Call' : 'Fold';
      const edge = (eq - req) * 100;

      html += `<div class="kvs">
                 <span class="kv">Equity שלך: ${(eq*100).toFixed(2)}%</span>
                 <span class="kv">EV(call): ${ev.toFixed(2)}</span>
                 <span class="kv">פער מול דרוש: ${edge.toFixed(2)}pp</span>
               </div>`;

      const css = (recommendation === 'Call') ? 'ok' : 'err';
      html += `<div class="msg ${css}"><b>המלצה:</b> ${recommendation}</div>`;
    }

    out.innerHTML = html;
  });

  /* ===== Vs Open (3-bet) ===== */
  byId('btn2').addEventListener('click', async () => {
    const out = byId('out2'), sp = byId('sp2');
    try {
      const body = {
        hand: byId('hand2').value.trim(),
        hero_pos: byId('hero2').value.trim(),
        opener_pos: byId('opener2').value.trim(),
        stack: Number(byId('stack2').value)
      };
      if (!body.hand || !body.hero_pos || !body.opener_pos || !body.stack) {
        renderVsOpen(out, {error:'נא למלא את כל השדות'}); return;
      }
      show(sp, true); out.textContent = 'טוען...';
      const data = await callJSON(`${API_BASE_URL}/vs-open`, body);
      renderVsOpen(out, data);
    } catch (e) {
      renderVsOpen(out, {error: String(e.message||e)});
    } finally {
      show(sp, false);
    }
  });
</script>
</body>
</html>
